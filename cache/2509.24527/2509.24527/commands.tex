\usepackage[letterpaper,margin=1in,footskip=24pt]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{pifont}
\usepackage[numbers,super,sort,compress]{natbib}
\usepackage[colorlinks]{hyperref}
\usepackage{mathtools}
\usepackage[capitalise,noabbrev,nameinlink]{cleveref}
\usepackage[hypcap=false]{caption}
\usepackage[hang,flushmargin,symbol]{footmisc}
\usepackage{booktabs}
\usepackage{array}
\usepackage{fancyhdr}
\usepackage{xcolor}
\usepackage{xparse}
\usepackage{xpatch}
\usepackage{tabularray}
\usepackage{environ}
\usepackage{changepage}
\usepackage{lineno}
\usepackage{subcaption}
\usepackage{graphicx}
\usepackage{amsfonts}
\usepackage{nicefrac}
\usepackage{enumitem}
\usepackage{titlesec}
\usepackage{xspace}
\usepackage{wrapfig}
\usepackage[noend]{algpseudocode}
\usepackage{algorithm}

\RequirePackage{XCharter}
\RequirePackage[xcharter,bigdelims,vvarbb]{newtxmath}
\RequirePackage[scaled=1.1]{zlmtt}

\newcommand{\method}{Dreamer~4\xspace}
\newcommand{\Method}{Dreamer~4\xspace}

% Page
\setlength{\skip\footins}{24pt}

% Title page
\fancypagestyle{plain}{%
\fancyhead[L]{\includegraphics[width=90pt]{logo}}
\fancyhead[C]{}
\fancyhead[R]{}
\fancyfoot[L]{\small%
* Equal contribution.\enskip
Google DeepMind, San Francisco, USA.\enskip
% Contact: mail@danijar.com \\[.5ex]
Website: \href{https://danijar.com/dreamer4}{danijar.com/dreamer4}
}
\fancyfoot[C]{}
\fancyfoot[R]{\small\thepage}
\renewcommand{\headrulewidth}{1pt}
\renewcommand{\footrulewidth}{1pt}
}

% Other pages
\fancypagestyle{fancy}{%
\fancyhead[L]{}
\fancyhead[C]{}
\fancyhead[R]{}
\fancyfoot[L]{}
\fancyfoot[C]{}
\fancyfoot[R]{\small\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
}

% Fix warning
\setlength{\headheight}{17pt}
\addtolength{\topmargin}{-3pt}

% Title
\makeatletter
\renewcommand{\maketitle}{%
\thispagestyle{plain}%
\bgroup%
\begin{center}%
\vspace*{0pt}%
{\bfseries\fontsize{20pt}{20pt}\selectfont\@title\par}
\vspace*{12pt}%
{\normalsize\@author\par}
\vspace*{10pt}%
\end{center}%
\egroup}
\makeatother

% Section number periods
\titleformat{\section}{\normalfont\Large\bfseries}{\thesection.}{.5em}{}
\titleformat{\subsection}{\normalfont\large\bfseries}{\thesubsection.}{.5em}{}

% Formatting
\definecolor{linkcolor}{rgb}{0.0,0.15,0.7}
\hypersetup{colorlinks=true,allcolors=linkcolor}
\setlength\parindent{0pt}
\setlength{\parskip}{.5\baselineskip}
\bibliographystyle{unsrtnat}
\captionsetup{labelfont=bf}
\setlist[itemize]{leftmargin=1.2em,labelsep=.7em,itemsep=0ex,topsep=0ex}
\renewcommand{\paragraph}[1]{\textbf{#1}\hspace{3ex}\removeParAfter}

% Tables
\UseTblrLibrary{booktabs}
\NewTblrColumnType{L}[1]{Q[l,m,wd=#1]}
\NewTblrColumnType{C}[1]{Q[c,m,wd=#1]}
\NewTblrColumnType{R}[1]{Q[r,m,wd=#1]}
\renewcommand{\o}{\hphantom{0}}
\NewEnviron{mytabular}[1]{%
\setlength\heavyrulewidth{1.2pt}
\setlength\lightrulewidth{.5pt}
\setlength\aboverulesep{.4ex}%
\setlength\belowrulesep{.8ex}%
\begin{booktabs}[expand=\BODY]{#1}
\BODY
\end{booktabs}
}

% References
\crefname{equation}{}{}
\crefname{algocf}{Algorithm}{Algorithms}
\Crefname{algocf}{Algorithm}{Algorithms}

% Pseudocode
\makeatletter
\newcommand{\algmargin}{\the\ALG@thistlm}
\makeatother
\algrenewcommand{\alglinenumber}[1]{$\bullet$}
\algdef{SxnE}[REPEATPLAIN]{RepeatPlain}{End}[0]{\algorithmicrepeat}{}
\newcommand{\CommentClean}[1]{\Statex\hspace*{-2.5ex}\texttt{// #1}}
\algnewcommand{\ParState}[1]{\State\parbox[t]{\dimexpr\linewidth-\algmargin}{\strut#1\strut}}
\algnewcommand{\ParStateIndent}[1]{\State\quad\parbox[t]{\dimexpr\linewidth-\algmargin}{\strut#1\strut}}

% TODOs
\makeatletter
\DeclareDocumentCommand\todo{g}{%
\def\@message{\IfNoValueTF{#1}{TODO}{TODO: #1}}
\textbf{\textcolor[HTML]{FF8811}{\@message}}
\@latex@warning{\@message}{}{}}
\makeatother

% Equation
\makeatletter
\newcommand{\removeParBefore}{\ifvmode\vspace*{-\baselineskip}\setlength{\parskip}{0ex}\fi}
\newcommand{\removeParAfter}{\@ifnextchar\par\@gobble\relax}
\newcommand{\eq}{\begingroup\removeParBefore\endlinechar=32 \eqinner}
\newcommand{\eqinner}[2][aligned]{\endlinechar=32%
\begin{gather}\begin{#1}#2\end{#1}\end{gather}\endgroup\removeParAfter}
\makeatother

% Density
\DeclareDocumentCommand{\p}{ D<>{p} D<>{} r() }{%
\def\content{#3}\patchcmd{\content}{|}{\;#2\vert\;}{}{}
\ensuremath{#1 #2(\content #2)}}

% Expectation
\DeclareDocumentCommand{\E}{ D<>{E} E{_}{{}} D<>{\big} r[] }{%
\def\content{#4}\patchcmd{\content}{|}{\;#3\vert\;}
{}\ensuremath{\operatorname{#1}_{#2}#3[\content #3]}}

% Helpers
\newcommand{\tlap}[1]{\vbox to 0pt{\vss\hbox{#1}}}
\newcommand{\blap}[1]{\vbox to 0pt{\hbox{#1}\vss}}
\newcommand{\cmark}{\textcolor{green}{\ding{51}}}
\newcommand{\xmark}{\textcolor{red}{\ding{55}}}
\renewcommand{\o}{\hphantom{0}}
\newcommand{\sg}{\operatorname{sg}}
\newcommand{\EMA}{\operatorname{EMA}}
\newcommand{\dhalf}{\textstyle\frac{d}{2}}
\newcommand{\sig}{\tau}  % t, m, s, alpha
\newcommand{\dis}{d}
